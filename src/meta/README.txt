This code is taken from meta library by Adam Chlipala and contributors:

http://hg.impredicative.com/meta
